# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Java CI with Maven  
  
on:  
  push:  
    branches: [ "main" ]  
  pull_request:  
    branches: [ "main" ]  
  
permissions:  
  contents: read  
  packages: write  
  checks: write    
  security-events: write    
  pull-requests: write  
  repository-projects: write  
  
jobs:  
  test:  
    runs-on: ${{ matrix.os }}  
    strategy:  
      matrix:  
        java: ['11', '17', '21']  
        os: [ubuntu-latest, windows-latest, macos-latest]  
      
    steps:  
    - uses: actions/checkout@v4  
      
    - name: Set up JDK ${{ matrix.java }}  
      uses: actions/setup-java@v4  
      with:  
        java-version: ${{ matrix.java }}  
        distribution: 'temurin'  
        cache: maven  
      
    - name: Build with Maven  
      run: mvn -B compile --file pom.xml  
      
    - name: Run Tests  
      run: mvn -B test --file pom.xml  
      
    - name: Generate Coverage Report  
      run: mvn jacoco:report  
      
    - name: Upload Coverage to Codecov  
      uses: codecov/codecov-action@v3  
      with:  
        file: ./target/site/jacoco/jacoco.xml  
  
  security-analysis:  
    runs-on: ubuntu-latest  
    needs: test  
      
    steps:  
    - uses: actions/checkout@v4  
      
    - name: Set up JDK 21  
      uses: actions/setup-java@v4  
      with:  
        java-version: '21'  
        distribution: 'temurin'  
        cache: maven  
      
    - name: OWASP Dependency Check  
      run: mvn org.owasp:dependency-check-maven:check  
      
    - name: Upload SARIF results  
      uses: github/codeql-action/upload-sarif@v2  
      with:  
        sarif_file: target/dependency-check-report.sarif  
  
  code-quality:  
    runs-on: ubuntu-latest  
    needs: test  
      
    steps:  
    - uses: actions/checkout@v4  
      with:  
        fetch-depth: 0  
      
    - name: Set up JDK 21  
      uses: actions/setup-java@v4  
      with:  
        java-version: '21'  
        distribution: 'temurin'  
        cache: maven  
      
    - name: SonarCloud Scan  
      env:  
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}  
      run: mvn sonar:sonar  
      
    - name: SpotBugs Analysis  
      run: mvn spotbugs:check  
      
    - name: PMD Analysis  
      run: mvn pmd:check  
  
  performance-tests:  
    runs-on: ubuntu-latest  
    needs: test  
      
    steps:  
    - uses: actions/checkout@v4  
      
    - name: Set up JDK 21  
      uses: actions/setup-java@v4  
      with:  
        java-version: '21'  
        distribution: 'temurin'  
        cache: maven  
      
    - name: Run JMH Benchmarks  
      run: mvn exec:java -Dexec.mainClass="org.openjdk.jmh.Main"  
      
    - name: Upload Benchmark Results  
      uses: actions/upload-artifact@v3  
      with:  
        name: benchmark-results  
        path: target/benchmarks/